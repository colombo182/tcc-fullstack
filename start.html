<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <style>
      body {
        background: #000;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .countdown {
        position: fixed;
        top: 20px;
        left: 20px;  /* Back to original position */
        color: #FFF;
        font-size: 16px;
        font-family: "Roboto Condensed";
        z-index: 1000;
      }
      .mirror-container {
        flex: 1;
        margin: 20px;
        position: relative;
        background: transparent;
      }
      .welcome-text {
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        text-align: center;
        color: #FFF;
        font-family: "Roboto Condensed";
        font-size: 24px;
      }
      .menu-button {
        position: absolute;
        top: 20px;    /* Match countdown top position */
        left: 0px;  /* Increased from -10px to move button more right */
        padding: 0;   /* Remove padding to match text size */
        margin: 0;
        background: transparent;
        color: #4285f4;  /* Changed from #FFF to blue */
        font-weight: bold;  /* Added bold */
        border: none;
        border-radius: 0;  /* Remove border radius */
        font-family: "Roboto Condensed";
        font-size: 16px;
        cursor: pointer;
        transition: color 0.2s ease;
      }
      .menu-button:hover {
        color: #80a9f6;
        background: transparent;
      }
      /* Removed .menu-button:active style */
      .weather-container {
        position: fixed;
        top: 20px;
        right: 20px;
        color: #FFF;
        font-family: "Roboto Condensed";
        text-align: right;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .clock {
        font-size: 18px;
        font-weight: bold;
        color: #FFF;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        text-align: right;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
      }
      .weather-info {
        margin-top: 10px;
        font-size: 16px;
        line-height: 1.8;
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        gap: 5px;
      }
      .news-container {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: #FFF;
        font-family: "Roboto Condensed";
        text-align: center;
        z-index: 1000;
        width: 80%;
        background: rgba(0,0,0,0.7);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .news-header {
        font-size: 14px;
        color: #4285f4;
        font-weight: bold;
        text-transform: uppercase;
      }
      .news-text {
        font-size: 16px;
        margin: 0;
        opacity: 1;
        transition: opacity 0.5s ease-in-out;
      }
      .news-text.fade {
        opacity: 0;
      }
      .dht-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        color: #FFF;
        font-family: "Roboto Condensed";
        text-align: center;
        z-index: 999;
      }
      .dht-reading {
        font-size: 24px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }
    </style>
  </head>
  <body>
    <div id="countdown" class="countdown"></div>
    <div class="mirror-container">
      <div class="welcome-text">Bem-vindo ao Espelho Inteligente</div>
      <button class="menu-button" onclick="window.location.href='menu.html'">Voltar ao Menu</button>
      <div class="dht-container">
        <div id="dht-temp" class="dht-reading"></div>
        <div id="dht-humidity" class="dht-reading"></div>
      </div>
    </div>
    <div class="weather-container">
      <div id="clock" class="clock"></div>
      <div id="dht-temp" style="font-size: 16px; margin-top: 10px;"></div>
      <div id="dht-humidity" style="font-size: 16px; margin-top: 5px;"></div>
      <div class="weather-info" id="weather-info"></div>
    </div>
    <div id="news-container" class="news-container">
      <div id="news-header" class="news-header"></div>
      <p id="news-text" class="news-text"></p>
    </div>
    <script>
      let countdownInterval;
      let secondsLeft = 30;

      startCountdown();

      function startCountdown() {
          clearInterval(countdownInterval);
          secondsLeft = 30;
          const countdownDisplay = document.getElementById('countdown');
          
          countdownInterval = setInterval(() => {
              secondsLeft--;
              countdownDisplay.textContent = `Tela desligará em: ${secondsLeft} segundos`;
              
              if (secondsLeft <= 0) {
                  clearInterval(countdownInterval);
                  const { exec } = require('child_process');
                  exec('bash scripts/display_off.sh', (error) => {
                      if (error) console.error('Error executing display_off.sh:', error);
                  });
                  countdownDisplay.textContent = 'Tela desligada';
              }
          }, 1000);
      }

      function resetCountdown() {
          clearInterval(countdownInterval);
          secondsLeft = 30;
          const { exec } = require('child_process');
          exec('bash scripts/display_on.sh', (error) => {
              if (error) console.error('Error executing display_on.sh:', error);
          });
          startCountdown();
      }

      document.addEventListener('mousemove', resetCountdown);
      document.addEventListener('keypress', resetCountdown);

      const API_KEY = '6c69e08fb45939e6ebc0cb6e9c8c317a'; // Replace with your OpenWeather API key
      let weatherUpdateInterval;

      function updateWeather() {
          const city = localStorage.getItem('localizacao');
          if (!city) return;

          fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${API_KEY}`)
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  return response.json();
              })
              .then(data => {
                  const weatherInfo = document.getElementById('weather-info');
                  weatherInfo.innerHTML = `
                      <img src="http://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" style="width: 85px; height: 85px; margin-top: 25px; margin-left: 25px;">
                      <div style="text-align: right">
                          <strong>${city}</strong><br>
                          Temperatura: ${data.main.temp.toFixed(1)}°C<br>
                          Umidade: ${data.main.humidity}%<br>
                          Sensação térmica: ${data.main.feels_like.toFixed(1)}°C<br>
                          Máxima: ${data.main.temp_max.toFixed(1)}°C<br>
                          Mínima: ${data.main.temp_min.toFixed(1)}°C
                      </div>
                  `;
              })
              .catch(error => {
                  console.error('Error fetching weather:', error);
                  // Wait longer before retrying on error
                  setTimeout(updateWeather, 900000); // 15 minutes
              });
      }

      function startWeatherUpdates() {
          const interval = localStorage.getItem('intervalo_medicao') || 600000; // Changed to 10 minutes default
          updateWeather();
          weatherUpdateInterval = setInterval(updateWeather, interval);
      }

      // Add RSS feed handling
      let newsIndex = 0;
      let newsItems = {
        agenciaBrasil: [],
        googleNews1: [],
        googleNews2: []
      };
      let currentSource = 'agenciaBrasil';
      let currentGoogleFeed = 1;

      async function fetchNews() {
        const newsHeader = document.getElementById('news-header');
        const fonte = localStorage.getItem('fonte_noticia');
        
        async function fetchAgenciaBrasil() {
          const response = await fetch('http://agenciabrasil.ebc.com.br/rss/ultimasnoticias/feed.xml');
          const text = await response.text();
          return parseNewsItems(text, 'Agência Brasil');
        }
        
        async function fetchGoogleNews1() {
          const response = await fetch('https://rss.app/feeds/fsGZHkrUNHGzFmsd.xml');
          const text = await response.text();
          return parseNewsItems(text, 'Google News');
        }
        
        async function fetchGoogleNews2() {
          const response = await fetch('https://rss.app/feeds/ZqLpsjBXCfy4oC33.xml');
          const text = await response.text();
          return parseNewsItems(text, 'Google News');
        }

        function parseNewsItems(text, source) {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, 'text/xml');
          const items = xmlDoc.querySelectorAll('item');
          return Array.from(items).map(item => ({
            title: item.querySelector('title').textContent,
            description: item.querySelector('description').textContent,
            source: source
          }));
        }

        try {
          if (fonte === 'Ambos portais') {
            const [agenciaBrasil, googleNews1, googleNews2] = await Promise.all([
              fetchAgenciaBrasil(),
              fetchGoogleNews1(),
              fetchGoogleNews2()
            ]);
            newsItems.agenciaBrasil = agenciaBrasil;
            newsItems.googleNews1 = googleNews1;
            newsItems.googleNews2 = googleNews2;
            rotateNews();
            setInterval(rotateNews, 10000);
          } else if (fonte === 'Google News') {
            newsHeader.textContent = fonte.toUpperCase();
            const [news1, news2] = await Promise.all([
              fetchGoogleNews1(),
              fetchGoogleNews2()
            ]);
            newsItems.googleNews1 = news1;
            newsItems.googleNews2 = news2;
            rotateNews();
            setInterval(rotateNews, 10000);
          } else if (fonte === 'Agência Brasil') {
            newsHeader.textContent = fonte.toUpperCase();
            newsItems = await fetchAgenciaBrasil();
            rotateNews();
            setInterval(rotateNews, 10000);
          }
        } catch (error) {
          console.error('Error fetching news:', error);
        }
      }
      
      function rotateNews() {
        const fonte = localStorage.getItem('fonte_noticia');
        const newsText = document.getElementById('news-text');
        const newsHeader = document.getElementById('news-header');
        
        newsText.classList.add('fade');
        
        setTimeout(() => {
          if (fonte === 'Ambos portais') {
            if (currentSource === 'agenciaBrasil') {
              const item = newsItems.agenciaBrasil[newsIndex % newsItems.agenciaBrasil.length];
              newsText.textContent = item.title;
              newsHeader.textContent = 'AGÊNCIA BRASIL';
              currentSource = 'googleNews';
            } else {
              // Alternate between Google News feeds
              const items = currentGoogleFeed === 1 ? newsItems.googleNews1 : newsItems.googleNews2;
              const item = items[newsIndex % items.length];
              newsText.textContent = item.title;
              newsHeader.textContent = 'GOOGLE NEWS';
              currentSource = 'agenciaBrasil';
              currentGoogleFeed = currentGoogleFeed === 1 ? 2 : 1;
              newsIndex++;
            }
          } else if (fonte === 'Google News') {
            const items = currentGoogleFeed === 1 ? newsItems.googleNews1 : newsItems.googleNews2;
            const item = items[newsIndex % items.length];
            newsText.textContent = item.title;
            currentGoogleFeed = currentGoogleFeed === 1 ? 2 : 1;
            if (currentGoogleFeed === 1) newsIndex++;
          }
          
          requestAnimationFrame(() => {
            newsText.classList.remove('fade');
          });
        }, 500);
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        startWeatherUpdates();
        fetchNews();
      });

      // Update clock implementation
      async function updateClock() {
        try {
          const response = await fetch('/api/clock');
          if (!response.ok) throw new Error('Clock API failed');
          const data = await response.json();
          const format = localStorage.getItem('formato_hora') || '24';
          document.getElementById('clock').textContent = format === '12' ? data.h12 : data.h24;
        } catch (error) {
          console.error('Clock error:', error);
        }
      }

      // Local clock implementation
      function updateLocalClock() {
        const now = new Date();
        const format = localStorage.getItem('formato_hora') || '24';
        const clockElement = document.getElementById('clock');
        
        if (format === 'Sistema de 12:00 am e 12:00 pm' || format === '12') {
          const hours = now.getHours();
          const ampm = hours >= 12 ? 'PM' : 'AM';
          const hours12 = hours % 12 || 12;
          clockElement.innerHTML = 
            `${hours12.toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')} ${ampm}`;
        } else {
          clockElement.innerHTML = 
            `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }
      }

      // Start clock updates
      updateClock();
      updateLocalClock();
      setInterval(updateClock, 1000);
      setInterval(updateLocalClock, 1000);

      // Add DHT11 reading function
      function updateDHT() {
          const interval = localStorage.getItem('intervalo_medicao') || 10000;
          
          fetch('/dht_temp')
              .then(response => response.text())
              .then(temp => {
                  document.getElementById('dht-temp').textContent = temp;
              });
              
          fetch('/dht_humidity')
              .then(response => response.text())
              .then(humidity => {
                  document.getElementById('dht-humidity').textContent = humidity;
              });
      }

      // Start DHT11 updates with configured interval
      setInterval(updateDHT, parseInt(localStorage.getItem('intervalo_medicao')) || 10000);
      updateDHT();
    </script>
  </body>
</html>
